<!-- APIM policy for POST /api/ingest JWT validation and rate limiting -->
<policies>
  <inbound>
    <base />
    <validate-jwt header-name="Authorization" failed-validation-httpcode="401" failed-validation-error-message="Invalid token">
      <openid-config url="https://login.microsoftonline.com/{TENANT_ID}/v2.0/.well-known/openid-configuration" />
      <required-claims>
        <claim name="aud">
          <value>{API_CLIENT_ID}</value>
        </claim>
        <claim name="scp">
          <value>ingest.write</value>
        </claim>
      </required-claims>
    </validate-jwt>
    <rate-limit-by-key calls="60" renewal-period="60" counter-key="@(context.Subscription?.Key)" />
  </inbound>
  <backend>
    <base />
  </backend>
  <outbound>
    <base />
  </outbound>
  <on-error>
    <base />
  </on-error>
</policies>
